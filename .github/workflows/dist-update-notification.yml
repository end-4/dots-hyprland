name: Comment on Discussion When sdata/dist-arch/ Changes

on:
  push:
    branches:
      - main
    paths:
      - "sdata/dist-arch/**"
      - "!sdata/dist-arch/README.md"
#  workflow_dispatch:

jobs:
  comment_on_discussion:
    runs-on: ubuntu-latest
    steps:
      - name: Create comment on discussion #2140
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: 2140
        # https://docs.github.com/en/graphql/guides/using-the-graphql-api-for-discussions
        # https://docs.github.com/en/graphql/reference/mutations#adddiscussioncomment
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_EVENT_HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_EVENT_REPOSITORY_NAME: ${{ github.event.repository.name }}
        run: |
          MESSAGE="**Auto notification:**\n"
          MESSAGE+="Directory \`sdata/dist-arch\` has been updated.\n"
          MESSAGE+="Commit HASH: "$GITHUB_SHA"\n"
          MESSAGE+="Commit message: "$GITHUB_EVENT_HEAD_COMMIT_MESSAGE""
          REPO_OWNER=""$GITHUB_REPOSITORY_OWNER""
          REPO_NAME=""$GITHUB_EVENT_REPOSITORY_NAME""

          DISCUSSION_NODE_ID=$(gh api graphql -f query='
            query {
              repository( owner: "'${REPO_OWNER}'", name: "'${REPO_NAME}'" )
                { discussion(number: '${DISCUSSION_NUMBER}') { id } } 
              }' | \
            jq -r '.data.repository.discussion.id')
          gh api graphql -f query='
            mutation {
              addDiscussionComment(input:{
                discussionId: "'$DISCUSSION_NODE_ID'",
                body: "'"$MESSAGE"'",
              }) {
                clientMutationId
                comment {
                  id
                  body
                }
              }
            }
          '
